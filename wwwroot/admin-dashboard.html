<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Student Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        :root {
            --primary-color: #5469d4;
            --secondary-color: #4655a8;
            --accent-color: #f7fafc;
            --text-color: #2d3748;
            --light-text: #718096;
            --success-color: #38a169;
            --danger-color: #e53e3e;
            --warning-color: #f6ad55;
            --info-color: #63b3ed;
            --border-radius: 10px;
            --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --border-color: #e2e8f0;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-color);
            background-color: #f7fafc;
            line-height: 1.6;
        }
        
        /* Navbar styling */
        .navbar {
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-dark.bg-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)) !important;
        }
        
        .navbar-brand {
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        /* Card styling */
        .card {
            border: none;
            box-shadow: var(--card-shadow);
            border-radius: var(--border-radius);
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
        }
        
        /* Admin specific styles */
        .stat-card {
            min-height: 120px;
        }
        
        .stat-card .icon {
            font-size: 2.5rem;
            opacity: 0.8;
        }
        
        .stat-card .count {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .stat-card .title {
            font-size: 1rem;
            color: var(--light-text);
        }
        
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .data-table th {
            background-color: #f9fafb;
            font-weight: 600;
            color: var(--text-color);
            border-bottom: 2px solid var(--border-color);
        }
        
        .data-table td, .data-table th {
            padding: 1rem;
            text-align: left;
        }
        
        .data-table tbody tr {
            border-bottom: 1px solid var(--border-color);
        }
        
        .data-table tbody tr:hover {
            background-color: rgba(84, 105, 212, 0.05);
        }
        
        /* Pagination styles */
        .pagination .page-link {
            color: var(--primary-color);
            border: none;
            margin: 0 2px;
            border-radius: 4px;
        }
        
        .pagination .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shield-lock-fill me-2"></i>
                Student Tracker Admin
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#dashboard-section">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#users-section">
                            <i class="bi bi-people"></i> Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#tracking-section">
                            <i class="bi bi-geo-alt"></i> Tracking
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#subjects-section">
                            <i class="bi bi-book"></i> Subjects
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logout-btn">
                            <i class="bi bi-box-arrow-right"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container py-4">
        <!-- Dashboard Overview Section -->
        <section id="dashboard-section" class="mb-5">
            <h2 class="mb-4">Dashboard Overview</h2>
            
            <!-- Statistics Cards -->
            <div class="row g-4 mb-4">
                <!-- Students Stats -->
                <div class="col-md-4 col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body d-flex align-items-center">
                            <div class="icon text-primary me-3">
                                <i class="bi bi-mortarboard-fill"></i>
                            </div>
                            <div>
                                <div class="count" id="students-count">-</div>
                                <div class="title">Students</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Parents Stats -->
                <div class="col-md-4 col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body d-flex align-items-center">
                            <div class="icon text-success me-3">
                                <i class="bi bi-person-fill"></i>
                            </div>
                            <div>
                                <div class="count" id="parents-count">-</div>
                                <div class="title">Parents</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Teachers Stats -->
                <div class="col-md-4 col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body d-flex align-items-center">
                            <div class="icon text-info me-3">
                                <i class="bi bi-person-workspace"></i>
                            </div>
                            <div>
                                <div class="count" id="teachers-count">-</div>
                                <div class="title">Teachers</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Subjects Stats -->
                <div class="col-md-4 col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body d-flex align-items-center">
                            <div class="icon text-warning me-3">
                                <i class="bi bi-book-fill"></i>
                            </div>
                            <div>
                                <div class="count" id="subjects-count">-</div>
                                <div class="title">Subjects</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Active Sessions Stats -->
                <div class="col-md-4 col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body d-flex align-items-center">
                            <div class="icon text-success me-3">
                                <i class="bi bi-record-circle-fill"></i>
                            </div>
                            <div>
                                <div class="count" id="active-sessions-count">-</div>
                                <div class="title">Active Sessions</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Total Sessions Stats -->
                <div class="col-md-4 col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body d-flex align-items-center">
                            <div class="icon text-secondary me-3">
                                <i class="bi bi-clock-history"></i>
                            </div>
                            <div>
                                <div class="count" id="total-sessions-count">-</div>
                                <div class="title">Total Sessions</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Location Points Stats -->
                <div class="col-md-4 col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body d-flex align-items-center">
                            <div class="icon text-danger me-3">
                                <i class="bi bi-geo-alt-fill"></i>
                            </div>
                            <div>
                                <div class="count" id="location-points-count">-</div>
                                <div class="title">Location Points</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Connections Stats -->
                <div class="col-md-4 col-lg-3">
                    <div class="card stat-card">
                        <div class="card-body d-flex align-items-center">
                            <div class="icon text-primary me-3">
                                <i class="bi bi-link-45deg"></i>
                            </div>
                            <div>
                                <div>
                                    <span id="student-parent-connections-count">-</span> / <span id="student-teacher-connections-count">-</span>
                                </div>
                                <div class="title">Parent/Teacher Connections</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Storage Info -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-hdd me-2"></i>
                    Storage Usage
                </div>
                <div class="card-body">
                    <p>Tracking data comprises <span id="tracking-percentage">-</span>% of the database records.</p>
                    <div class="progress">
                        <div class="progress-bar bg-info" role="progressbar" style="width: 0%;" id="tracking-progress-bar">0%</div>
                    </div>
                    <div class="small mt-2 text-muted">
                        <span id="tracking-records">-</span> out of <span id="total-records">-</span> total records
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-danger" id="purge-tracking-data-btn">
                            <i class="bi bi-trash"></i> Purge Completed Tracking Data
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Users Section -->
        <section id="users-section" class="mb-5">
            <h2 class="mb-4">User Management</h2>
            
            <!-- User Tabs -->
            <ul class="nav nav-tabs mb-4" id="usersTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="students-tab" data-bs-toggle="tab" data-bs-target="#students-pane" type="button" role="tab">
                        <i class="bi bi-mortarboard me-2"></i>Students
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="parents-tab" data-bs-toggle="tab" data-bs-target="#parents-pane" type="button" role="tab">
                        <i class="bi bi-person me-2"></i>Parents
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="teachers-tab" data-bs-toggle="tab" data-bs-target="#teachers-pane" type="button" role="tab">
                        <i class="bi bi-person-workspace me-2"></i>Teachers
                    </button>
                </li>
            </ul>
            
            <!-- Tab Content -->
            <div class="tab-content" id="usersTabContent">
                <!-- Students Tab -->
                <div class="tab-pane fade show active" id="students-pane" role="tabpanel" tabindex="0">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Students List</span>
                            <div>
                                <button class="btn btn-sm btn-outline-primary refresh-btn" data-target="students">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="data-table table" id="students-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Full Name</th>
                                            <th>Username</th>
                                            <th>Email</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="6" class="text-center">Loading students data...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Students Pagination -->
                            <nav class="mt-3">
                                <ul class="pagination justify-content-center" id="students-pagination">
                                    <!-- Pagination will be added by JavaScript -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                
                <!-- Parents Tab -->
                <div class="tab-pane fade" id="parents-pane" role="tabpanel" tabindex="0">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Parents List</span>
                            <div>
                                <button class="btn btn-sm btn-outline-primary refresh-btn" data-target="parents">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="data-table table" id="parents-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Full Name</th>
                                            <th>Username</th>
                                            <th>Email</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="6" class="text-center">Loading parents data...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Parents Pagination -->
                            <nav class="mt-3">
                                <ul class="pagination justify-content-center" id="parents-pagination">
                                    <!-- Pagination will be added by JavaScript -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                
                <!-- Teachers Tab -->
                <div class="tab-pane fade" id="teachers-pane" role="tabpanel" tabindex="0">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span>Teachers List</span>
                            <div>
                                <button class="btn btn-sm btn-outline-primary refresh-btn" data-target="teachers">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="data-table table" id="teachers-table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Full Name</th>
                                            <th>Username</th>
                                            <th>Email</th>
                                            <th>Created</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="6" class="text-center">Loading teachers data...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <!-- Teachers Pagination -->
                            <nav class="mt-3">
                                <ul class="pagination justify-content-center" id="teachers-pagination">
                                    <!-- Pagination will be added by JavaScript -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tracking Sessions Section -->
        <section id="tracking-section" class="mb-5">
            <h2 class="mb-4">Tracking Sessions</h2>
            
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Tracking Sessions List</span>
                    <div>
                        <button class="btn btn-sm btn-outline-primary refresh-btn" data-target="tracking-sessions">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <button class="btn btn-sm btn-danger ms-2" id="purge-modal-btn" data-bs-toggle="modal" data-bs-target="#purgeModal">
                            <i class="bi bi-trash"></i> Purge Data
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="data-table table" id="tracking-sessions-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Student</th>
                                    <th>Start Time</th>
                                    <th>End Time</th>
                                    <th>Duration</th>
                                    <th>Locations</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="7" class="text-center">Loading tracking sessions...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Tracking Sessions Pagination -->
                    <nav class="mt-3">
                        <ul class="pagination justify-content-center" id="tracking-sessions-pagination">
                            <!-- Pagination will be added by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </section>

        <!-- Subjects Section -->
        <section id="subjects-section" class="mb-5">
            <h2 class="mb-4">Subjects Management</h2>
            
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Subjects List</span>
                    <div>
                        <button class="btn btn-sm btn-outline-primary refresh-btn" data-target="subjects">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="data-table table" id="subjects-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Teacher</th>
                                    <th>Students</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td colspan="7" class="text-center">Loading subjects data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Subjects Pagination -->
                    <nav class="mt-3">
                        <ul class="pagination justify-content-center" id="subjects-pagination">
                            <!-- Pagination will be added by JavaScript -->
                        </ul>
                    </nav>
                </div>
            </div>
        </section>
    </div>

    <!-- Purge Data Modal -->
    <div class="modal fade" id="purgeModal" tabindex="-1" aria-labelledby="purgeModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="purgeModalLabel">Purge Tracking Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>Warning:</strong> This action cannot be undone. Data will be permanently deleted.
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Purge Options:</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="purgeOption" id="purgeCompleted" value="completed" checked>
                            <label class="form-check-label" for="purgeCompleted">
                                Purge only completed tracking sessions
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="purgeOption" id="purgeOlderThan" value="olderThan">
                            <label class="form-check-label" for="purgeOlderThan">
                                Purge sessions older than a specific date
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="purgeOption" id="purgeAll" value="all">
                            <label class="form-check-label" for="purgeAll">
                                Purge ALL tracking data (complete wipe)
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="datePickerContainer" style="display: none;">
                        <label for="purgeDate" class="form-label">Purge data older than:</label>
                        <input type="date" class="form-control" id="purgeDate">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-purge-btn">Purge Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        <strong>Warning:</strong> This action cannot be undone. The item will be permanently deleted.
                    </div>
                    <p id="delete-message">Are you sure you want to delete this item?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap and Required JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        // Global variables
        let token = localStorage.getItem('token');
        let currentUser = JSON.parse(localStorage.getItem('user') || '{}');
        
        // Check authentication
        if (!token || !currentUser) {
            window.location.href = '/login.html';
        }
        
        // Current page state
        let currentPages = {
            students: 1,
            parents: 1,
            teachers: 1,
            'tracking-sessions': 1,
            subjects: 1
        };
        
        // API base URL
        const apiUrl = '/api';
        
        // Wait for DOM to load
        document.addEventListener('DOMContentLoaded', function() {
            // Setup auth header for all fetch requests
            setupAuthHeader();
            
            // Initialize the dashboard
            loadDashboardData();
            
            // Initial data loading
            loadStudentsData();
            
            // Setup event listeners
            setupEventListeners();
            
            // Tab change handling
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', event => {
                    const target = event.target.getAttribute('data-bs-target').replace('#', '').replace('-pane', '');
                    if (target === 'parents') {
                        loadParentsData();
                    } else if (target === 'teachers') {
                        loadTeachersData();
                    }
                });
            });
            
            // Prevent unauthorized access
            document.querySelectorAll('#navbarNav .nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    if (link.getAttribute('href') === '#tracking-section') {
                        loadTrackingSessionsData();
                    } else if (link.getAttribute('href') === '#subjects-section') {
                        loadSubjectsData();
                    }
                });
            });
            
            // Setup logout button
            document.getElementById('logout-btn').addEventListener('click', function() {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login.html';
            });
        });
        
        // Setup Authorization Header for Fetch API
        function setupAuthHeader() {
            const originalFetch = window.fetch;
            window.fetch = function(url, options = {}) {
                options.headers = options.headers || {};
                if (token) {
                    options.headers['Authorization'] = `Bearer ${token}`;
                }
                return originalFetch(url, options);
            };
        }
        
        // Set up event listeners
        function setupEventListeners() {
            // Refresh buttons
            document.querySelectorAll('.refresh-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const target = this.getAttribute('data-target');
                    if (target === 'students') {
                        loadStudentsData();
                    } else if (target === 'parents') {
                        loadParentsData();
                    } else if (target === 'teachers') {
                        loadTeachersData();
                    } else if (target === 'tracking-sessions') {
                        loadTrackingSessionsData();
                    } else if (target === 'subjects') {
                        loadSubjectsData();
                    }
                });
            });
            
            // Purge tracking data button
            document.getElementById('purge-tracking-data-btn').addEventListener('click', function() {
                const confirmed = confirm('Are you sure you want to purge all completed tracking data? This action cannot be undone.');
                if (confirmed) {
                    purgeTrackingData();
                }
            });
            
            // Purge options in modal
            document.querySelectorAll('input[name="purgeOption"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const datePickerContainer = document.getElementById('datePickerContainer');
                    if (this.value === 'olderThan') {
                        datePickerContainer.style.display = 'block';
                    } else {
                        datePickerContainer.style.display = 'none';
                    }
                });
            });
            
            // Confirm purge button in modal
            document.getElementById('confirm-purge-btn').addEventListener('click', function() {
                const purgeOption = document.querySelector('input[name="purgeOption"]:checked').value;
                
                if (purgeOption === 'completed') {
                    purgeTrackingData();
                } else if (purgeOption === 'olderThan') {
                    const date = document.getElementById('purgeDate').value;
                    if (!date) {
                        alert('Please select a date');
                        return;
                    }
                    purgeTrackingData(new Date(date).toISOString());
                } else if (purgeOption === 'all') {
                    const confirmed = confirm('WARNING: This will delete ALL tracking data, including active sessions. Are you absolutely sure?');
                    if (confirmed) {
                        purgeTrackingData(null, true);
                    }
                }
                
                // Close modal
                const purgeModal = bootstrap.Modal.getInstance(document.getElementById('purgeModal'));
                purgeModal.hide();
            });
            
            // Add delete button event listener
            document.getElementById('confirm-delete-btn').addEventListener('click', function() {
                const deleteType = this.getAttribute('data-delete-type');
                const deleteId = this.getAttribute('data-delete-id');
                
                if (deleteType && deleteId) {
                    deleteItem(deleteType, deleteId);
                }
            });
        }
        
        // Load Dashboard Data
        async function loadDashboardData() {
            try {
                const response = await fetch(`${apiUrl}/Admin/dashboard`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch dashboard data');
                }
                
                const data = await response.json();
                
                // Update statistics
                document.getElementById('students-count').textContent = data.counts.students;
                document.getElementById('parents-count').textContent = data.counts.parents;
                document.getElementById('teachers-count').textContent = data.counts.teachers;
                document.getElementById('subjects-count').textContent = data.counts.subjects;
                document.getElementById('active-sessions-count').textContent = data.counts.activeSessions;
                document.getElementById('total-sessions-count').textContent = data.counts.totalSessions;
                document.getElementById('location-points-count').textContent = data.counts.locationPoints;
                document.getElementById('student-parent-connections-count').textContent = data.counts.studentParentConnections;
                document.getElementById('student-teacher-connections-count').textContent = data.counts.studentTeacherConnections;
                
                // Update tracking storage
                document.getElementById('tracking-percentage').textContent = data.trackingStorage.percentage;
                document.getElementById('tracking-progress-bar').style.width = `${data.trackingStorage.percentage}%`;
                document.getElementById('tracking-progress-bar').textContent = `${data.trackingStorage.percentage}%`;
                document.getElementById('tracking-records').textContent = data.trackingStorage.trackingRecords;
                document.getElementById('total-records').textContent = data.trackingStorage.totalRecords;
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                alert('Failed to load dashboard data. Please try refreshing the page.');
            }
        }
        
        // Load Students Data
        async function loadStudentsData(page = 1) {
            try {
                currentPages.students = page;
                const response = await fetch(`${apiUrl}/Admin/students?page=${page}&pageSize=10`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch students data');
                }
                
                const data = await response.json();
                
                const tbody = document.querySelector('#students-table tbody');
                tbody.innerHTML = '';
                
                if (data.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No students found</td></tr>';
                    return;
                }
                
                data.data.forEach(student => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${student.studentId}</td>
                        <td>
                            ${student.hasProfilePic ? '<i class="bi bi-person-circle me-2 text-muted"></i>' : ''}
                            ${student.fullname}
                        </td>
                        <td>${student.username}</td>
                        <td>${student.email}</td>
                        <td>${new Date(student.createdAt).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger delete-btn" data-type="student" data-id="${student.studentId}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Add delete button event listeners
                document.querySelectorAll('#students-table .delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        showDeleteConfirmation('student', this.getAttribute('data-id'));
                    });
                });
                
                // Update pagination
                updatePagination('students', data.page, data.totalPages);
                
            } catch (error) {
                console.error('Error loading students data:', error);
                document.querySelector('#students-table tbody').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-danger">Error loading students data</td></tr>';
            }
        }
        
        // Load Parents Data
        async function loadParentsData(page = 1) {
            try {
                currentPages.parents = page;
                const response = await fetch(`${apiUrl}/Admin/parents?page=${page}&pageSize=10`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch parents data');
                }
                
                const data = await response.json();
                
                const tbody = document.querySelector('#parents-table tbody');
                tbody.innerHTML = '';
                
                if (data.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No parents found</td></tr>';
                    return;
                }
                
                data.data.forEach(parent => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${parent.parentId}</td>
                        <td>
                            ${parent.hasProfilePic ? '<i class="bi bi-person-circle me-2 text-muted"></i>' : ''}
                            ${parent.fullname}
                        </td>
                        <td>${parent.username}</td>
                        <td>${parent.email}</td>
                        <td>${new Date(parent.createdAt).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger delete-btn" data-type="parent" data-id="${parent.parentId}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Add delete button event listeners
                document.querySelectorAll('#parents-table .delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        showDeleteConfirmation('parent', this.getAttribute('data-id'));
                    });
                });
                
                // Update pagination
                updatePagination('parents', data.page, data.totalPages);
                
            } catch (error) {
                console.error('Error loading parents data:', error);
                document.querySelector('#parents-table tbody').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-danger">Error loading parents data</td></tr>';
            }
        }
        
        // Load Teachers Data
        async function loadTeachersData(page = 1) {
            try {
                currentPages.teachers = page;
                const response = await fetch(`${apiUrl}/Admin/teachers?page=${page}&pageSize=10`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch teachers data');
                }
                
                const data = await response.json();
                
                const tbody = document.querySelector('#teachers-table tbody');
                tbody.innerHTML = '';
                
                if (data.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">No teachers found</td></tr>';
                    return;
                }
                
                data.data.forEach(teacher => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${teacher.teacherId}</td>
                        <td>
                            ${teacher.hasProfilePic ? '<i class="bi bi-person-circle me-2 text-muted"></i>' : ''}
                            ${teacher.fullname}
                        </td>
                        <td>${teacher.username}</td>
                        <td>${teacher.email}</td>
                        <td>${new Date(teacher.createdAt).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger delete-btn" data-type="teacher" data-id="${teacher.teacherId}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Add delete button event listeners
                document.querySelectorAll('#teachers-table .delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        showDeleteConfirmation('teacher', this.getAttribute('data-id'));
                    });
                });
                
                // Update pagination
                updatePagination('teachers', data.page, data.totalPages);
                
            } catch (error) {
                console.error('Error loading teachers data:', error);
                document.querySelector('#teachers-table tbody').innerHTML = 
                    '<tr><td colspan="6" class="text-center text-danger">Error loading teachers data</td></tr>';
            }
        }
        
        // Load Tracking Sessions Data
        async function loadTrackingSessionsData(page = 1) {
            try {
                currentPages['tracking-sessions'] = page;
                const response = await fetch(`${apiUrl}/Admin/tracking/sessions?page=${page}&pageSize=10`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch tracking sessions data');
                }
                
                const data = await response.json();
                
                const tbody = document.querySelector('#tracking-sessions-table tbody');
                tbody.innerHTML = '';
                
                if (data.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No tracking sessions found</td></tr>';
                    return;
                }
                
                data.data.forEach(session => {
                    const row = document.createElement('tr');
                    
                    // Format dates
                    const startTime = new Date(session.startTime).toLocaleString();
                    const endTime = session.endTime ? new Date(session.endTime).toLocaleString() : 'Active';
                    
                    // Status badge
                    const statusBadge = session.isActive 
                        ? '<span class="badge bg-success">Active</span>' 
                        : '<span class="badge bg-secondary">Completed</span>';
                    
                    row.innerHTML = `
                        <td>${session.sessionId}</td>
                        <td>${session.studentName} (ID: ${session.studentId})</td>
                        <td>${startTime}</td>
                        <td>${endTime}</td>
                        <td>${session.duration}</td>
                        <td>${session.locationCount}</td>
                        <td>${statusBadge}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Update pagination
                updatePagination('tracking-sessions', data.page, data.totalPages);
                
            } catch (error) {
                console.error('Error loading tracking sessions data:', error);
                document.querySelector('#tracking-sessions-table tbody').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-danger">Error loading tracking sessions data</td></tr>';
            }
        }
        
        // Load Subjects Data
        async function loadSubjectsData(page = 1) {
            try {
                currentPages.subjects = page;
                const response = await fetch(`${apiUrl}/Admin/subjects?page=${page}&pageSize=10`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch subjects data');
                }
                
                const data = await response.json();
                
                const tbody = document.querySelector('#subjects-table tbody');
                tbody.innerHTML = '';
                
                if (data.data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="text-center">No subjects found</td></tr>';
                    return;
                }
                
                data.data.forEach(subject => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${subject.subjectId}</td>
                        <td>${subject.name}</td>
                        <td>${subject.description || 'No description'}</td>
                        <td>${subject.teacherName} (ID: ${subject.teacherId})</td>
                        <td>${subject.studentsCount}</td>
                        <td>${new Date(subject.createdAt).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-danger delete-btn" data-type="subject" data-id="${subject.subjectId}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Add delete button event listeners
                document.querySelectorAll('#subjects-table .delete-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        showDeleteConfirmation('subject', this.getAttribute('data-id'));
                    });
                });
                
                // Update pagination
                updatePagination('subjects', data.page, data.totalPages);
                
            } catch (error) {
                console.error('Error loading subjects data:', error);
                document.querySelector('#subjects-table tbody').innerHTML = 
                    '<tr><td colspan="7" class="text-center text-danger">Error loading subjects data</td></tr>';
            }
        }
        
        // Helper functions
        
        // Update pagination UI
        function updatePagination(type, currentPage, totalPages) {
            const pagination = document.getElementById(`${type}-pagination`);
            pagination.innerHTML = '';
            
            // Previous button
            const prevLi = document.createElement('li');
            prevLi.classList.add('page-item');
            if (currentPage === 1) prevLi.classList.add('disabled');
            
            const prevLink = document.createElement('a');
            prevLink.classList.add('page-link');
            prevLink.innerHTML = '&laquo;';
            prevLink.href = '#';
            prevLink.addEventListener('click', function(e) {
                e.preventDefault();
                if (currentPage > 1) {
                    if (type === 'students') {
                        loadStudentsData(currentPage - 1);
                    } else if (type === 'parents') {
                        loadParentsData(currentPage - 1);
                    } else if (type === 'teachers') {
                        loadTeachersData(currentPage - 1);
                    } else if (type === 'tracking-sessions') {
                        loadTrackingSessionsData(currentPage - 1);
                    } else if (type === 'subjects') {
                        loadSubjectsData(currentPage - 1);
                    }
                }
            });
            
            prevLi.appendChild(prevLink);
            pagination.appendChild(prevLi);
            
            // Page numbers
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            if (endPage - startPage < 4 && totalPages > 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.classList.add('page-item');
                if (i === currentPage) pageLi.classList.add('active');
                
                const pageLink = document.createElement('a');
                pageLink.classList.add('page-link');
                pageLink.innerText = i;
                pageLink.href = '#';
                pageLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (type === 'students') {
                        loadStudentsData(i);
                    } else if (type === 'parents') {
                        loadParentsData(i);
                    } else if (type === 'teachers') {
                        loadTeachersData(i);
                    } else if (type === 'tracking-sessions') {
                        loadTrackingSessionsData(i);
                    } else if (type === 'subjects') {
                        loadSubjectsData(i);
                    }
                });
                
                pageLi.appendChild(pageLink);
                pagination.appendChild(pageLi);
            }
            
            // Next button
            const nextLi = document.createElement('li');
            nextLi.classList.add('page-item');
            if (currentPage === totalPages) nextLi.classList.add('disabled');
            
            const nextLink = document.createElement('a');
            nextLink.classList.add('page-link');
            nextLink.innerHTML = '&raquo;';
            nextLink.href = '#';
            nextLink.addEventListener('click', function(e) {
                e.preventDefault();
                if (currentPage < totalPages) {
                    if (type === 'students') {
                        loadStudentsData(currentPage + 1);
                    } else if (type === 'parents') {
                        loadParentsData(currentPage + 1);
                    } else if (type === 'teachers') {
                        loadTeachersData(currentPage + 1);
                    } else if (type === 'tracking-sessions') {
                        loadTrackingSessionsData(currentPage + 1);
                    } else if (type === 'subjects') {
                        loadSubjectsData(currentPage + 1);
                    }
                }
            });
            
            nextLi.appendChild(nextLink);
            pagination.appendChild(nextLi);
        }
        
        // Show delete confirmation modal
        function showDeleteConfirmation(type, id) {
            const modal = document.getElementById('deleteModal');
            const confirmBtn = document.getElementById('confirm-delete-btn');
            const message = document.getElementById('delete-message');
            
            // Set message based on type
            if (type === 'student') {
                message.textContent = `Are you sure you want to delete student with ID ${id}? This will also delete all associated tracking data and connections.`;
            } else if (type === 'parent') {
                message.textContent = `Are you sure you want to delete parent with ID ${id}? This will also delete all connections to students.`;
            } else if (type === 'teacher') {
                message.textContent = `Are you sure you want to delete teacher with ID ${id}? This will also delete all subjects and connections.`;
            } else if (type === 'subject') {
                message.textContent = `Are you sure you want to delete subject with ID ${id}? This will also delete all connections to students.`;
            }
            
            // Set data attributes
            confirmBtn.setAttribute('data-delete-type', type);
            confirmBtn.setAttribute('data-delete-id', id);
            
            // Show modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
        }
        
        // Delete item function
        async function deleteItem(type, id) {
            try {
                let endpoint;
                
                if (type === 'student' || type === 'parent' || type === 'teacher') {
                    endpoint = `${apiUrl}/Admin/users/${type}/${id}`;
                } else if (type === 'subject') {
                    endpoint = `${apiUrl}/Admin/subjects/${id}`;
                } else {
                    throw new Error('Invalid delete type');
                }
                
                const response = await fetch(endpoint, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`Failed to delete ${type}`);
                }
                
                const data = await response.json();
                
                // Show success message
                alert(data.message || `${type.charAt(0).toUpperCase() + type.slice(1)} deleted successfully`);
                
                // Close modal
                const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));
                deleteModal.hide();
                
                // Refresh data
                if (type === 'student') {
                    loadStudentsData(currentPages.students);
                } else if (type === 'parent') {
                    loadParentsData(currentPages.parents);
                } else if (type === 'teacher') {
                    loadTeachersData(currentPages.teachers);
                } else if (type === 'subject') {
                    loadSubjectsData(currentPages.subjects);
                }
                
                // Refresh dashboard data
                loadDashboardData();
                
            } catch (error) {
                console.error(`Error deleting ${type}:`, error);
                alert(`Failed to delete ${type}. Error: ${error.message}`);
            }
        }
        
        // Purge tracking data function
        async function purgeTrackingData(olderThan = null, completeWipe = false) {
            try {
                let endpoint = `${apiUrl}/Admin/tracking/purge`;
                
                // Add query parameters
                if (olderThan) {
                    endpoint += `?olderThan=${olderThan}`;
                }
                
                if (completeWipe) {
                    endpoint += endpoint.includes('?') ? '&' : '?';
                    endpoint += `completeWipe=true`;
                }
                
                const response = await fetch(endpoint, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to purge tracking data');
                }
                
                const data = await response.json();
                
                // Show success message
                alert(data.message || `Successfully purged ${data.deletedSessions} sessions and ${data.deletedLocationPoints} location points`);
                
                // Refresh data
                loadDashboardData();
                loadTrackingSessionsData(1);
                
            } catch (error) {
                console.error('Error purging tracking data:', error);
                alert(`Failed to purge tracking data. Error: ${error.message}`);
            }
        }
    </script>
</body>
</html>
